<section class="form-dialog post-form">
  <header class="form-dialog__header">
    <h2 class="form-dialog__title">{{ dialogTitle() }}</h2>
    <p class="form-dialog__subtitle">{{ dialogSubtitle() }}</p>
  </header>

  @if (loadingUsers() && !users().length) {
    <div class="post-form__loading">
      <mat-progress-spinner
        mode="indeterminate"
        diameter="24"
        strokeWidth="3"
      ></mat-progress-spinner>
      <span>{{ 'postForm.loadingUsers' | appTranslate }}</span>
    </div>
  }

  @if (loadError(); as error) {
    <app-alert variant="error" [dismissible]="false">
      <div class="post-form__error-content">
        <p>{{ error }}</p>
        <button
          appButton
          variant="ghost"
          size="sm"
          type="button"
          (click)="retryLoadUsers()"
          [disabled]="loadingUsers()"
        >
          {{ 'common.actions.retry' | appTranslate }}
        </button>
      </div>
    </app-alert>
  }

  <form class="form form-dialog__body" [formGroup]="form" (ngSubmit)="submit()">
    <div class="form-field" [class.is-invalid]="userIdInvalid">
      <app-select
        class="post-form__field"
        [control]="form.controls.userId"
        [label]="'postForm.fields.author' | appTranslate"
        [placeholder]="'postForm.selectAuthor' | appTranslate"
        [options]="userOptions()"
        [required]="true"
      >
        @if (loadingUsers()) {
          <mat-hint>{{ 'postForm.loadingUsers' | appTranslate }}</mat-hint>
        }
        @if (userIdInvalid) {
          <mat-error>{{ 'postForm.errors.author' | appTranslate }}</mat-error>
        } @else if (isMissingAuthor) {
          <mat-hint class="post-form__missing-author">
            {{
              'postForm.missingAuthor'
                | appTranslate
                  : {
                      id: form.controls.userId.value,
                    }
            }}
          </mat-hint>
        }
      </app-select>
    </div>

    <div class="form-field" [class.is-invalid]="titleInvalid">
      <mat-form-field
        class="post-form__field"
        appearance="outline"
        color="accent"
        [floatLabel]="'always'"
      >
        <mat-label>{{ 'postForm.fields.title' | appTranslate }}</mat-label>
        <input
          matInput
          id="post-title"
          type="text"
          formControlName="title"
          placeholder="{{ 'common.placeholders.postTitle' | appTranslate }}"
          appAutoFocus
          [attr.aria-invalid]="titleInvalid ? 'true' : null"
          maxlength="120"
        />
        <mat-hint align="end">{{ form.controls.title.value.length }}/120</mat-hint>
        @if (titleInvalid) {
          <mat-error>{{ 'postForm.errors.title' | appTranslate }}</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-field" [class.is-invalid]="bodyInvalid">
      <mat-form-field
        class="post-form__field post-form__field--textarea"
        appearance="outline"
        color="accent"
        [floatLabel]="'always'"
      >
        <mat-label>{{ 'postForm.fields.content' | appTranslate }}</mat-label>
        <textarea
          matInput
          id="post-body"
          formControlName="body"
          rows="8"
          placeholder="{{ 'common.placeholders.postBody' | appTranslate }}"
          [attr.aria-invalid]="bodyInvalid ? 'true' : null"
          maxlength="500"
        ></textarea>
        <mat-hint align="end">{{ form.controls.body.value.length }}/500</mat-hint>
        @if (bodyInvalid) {
          <mat-error>{{ 'postForm.errors.body' | appTranslate }}</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-actions form-dialog__actions">
      <button
        appButton
        variant="ghost"
        type="button"
        (click)="cancel()"
        [disabled]="submitting()"
        [attr.aria-label]="'common.actions.cancel' | appTranslate"
      >
        <mat-icon svgIcon="lucide:x" aria-hidden="true"></mat-icon>
        <span class="btn__label">{{ 'common.actions.cancel' | appTranslate }}</span>
      </button>
      <button
        appButton
        variant="primary"
        type="submit"
        [loading]="submitting()"
        [disabled]="submitting() || !users().length || loadingUsers() || !hasValidAuthor()"
        [attr.aria-label]="submitLabel()"
      >
        @if (isEdit()) {
          <mat-icon svgIcon="lucide:save" aria-hidden="true"></mat-icon>
        } @else {
          <mat-icon svgIcon="lucide:check" aria-hidden="true"></mat-icon>
        }
        <span class="btn__label">{{ submitLabel() }}</span>
      </button>
    </div>
  </form>
</section>
